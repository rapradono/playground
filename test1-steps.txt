#================================================================================
# [1] Setup "anaconda3.B"
#================================================================================
(base) sekigawa@LM19:~ (3)$ ll | grep anaconda3
(base) sekigawa@LM19:~ (4)$ mv anaconda3 anaconda3.B
(base) sekigawa@LM19:~ (5)$ ln -s anaconda3.B anaconda3
(base) sekigawa@LM19:~ (6)$ ll | grep anaconda3

(base) sekigawa@LM19:~ (9)$ conda install ruby=3.1.2
(base) sekigawa@LM19:~ (10)$ conda update --all
(base) sekigawa@LM19:~ (11)$ conda clean --all
(base) sekigawa@LM19:~/anaconda3/lib (12)$ pwd
(base) sekigawa@LM19:~/anaconda3/lib (13)$ ll | grep ruby
(base) sekigawa@LM19:~/anaconda3/lib (14)$ file libruby.so.3.1.2
libruby.so.3.1.2: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), \
    dynamically linked, with debug_info, not stripped
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

(base) sekigawa@LM19:~/anaconda3/lib (15)$ strip libruby.so.3.1.2

(base) sekigawa@LM19:~/anaconda3/lib (16)$ file libruby.so.3.1.2
libruby.so.3.1.2: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), \
    dynamically linked, stripped
                        ^^^^^^^^so

sekigawa@LM19:~ (17)$ pwd
sekigawa@LM19:~ (18)$ mv anaconda3 anaconda3.B
(base) sekigawa@LM19:~ (19)$ ln -s anaconda3.B anaconda3
(base) sekigawa@LM19:~ (20)$ ll | grep anaconda

#================================================================================
# [2] Install OpenGL libraries using distribution's package manager
#================================================================================
(base) sekigawa@LM19:/usr/lib/x86_64-linux-gnu (1)$ pwd
(base) sekigawa@LM19:/usr/lib/x86_64-linux-gnu (2)$ ll | grep libGL

#================================================================================
# [2.b] Download and move scripts
#================================================================================
git clone https://github.com/rapradono/playground.git
cd playground
cp test1.sh test2.sh ~/klayout

#================================================================================
# [3] Execute "ana3B-1.sh"
#================================================================================
(base) sekigawa@LM19:~/GitWork/klayout (1)$ ./ana3B-1.sh
:
:
:
g++ -Wl,-O1 -Wl,-rpath,/home/sekigawa/anaconda3/lib -o ./fontgen fontgen.o   /home/sekigawa/\
anaconda3/lib/libQt5Widgets.so /home/sekigawa/anaconda3/lib/libQt5Gui.so /home/sekigawa/anaconda3/\
lib/libQt5Core.so -L/opt/conda/conda-bld/qt-main_1660123285207/_build_env/\
bin/../x86_64-conda-linux-gnu/sysroot/usr/lib64 -lGL -lpthread

/home/sekigawa/anaconda3/lib/libQt5Widgets.so: undefined reference to \
`std::pmr::monotonic_buffer_resource::~monotonic_buffer_resource()@GLIBCXX_3.4.28'

/home/sekigawa/anaconda3/lib/libQt5Core.so: undefined reference to \
`std::__exception_ptr::exception_ptr::_M_release()@CXXABI_1.3.13'

/home/sekigawa/anaconda3/lib/libQt5Widgets.so: undefined reference to `vtable for \
std::pmr::monotonic_buffer_resource@GLIBCXX_3.4.28'

/home/sekigawa/anaconda3/lib/libQt5Widgets.so: undefined reference to \
`std::pmr::get_default_resource()@GLIBCXX_3.4.26'

/home/sekigawa/anaconda3/lib/libQt5Widgets.so: undefined reference to \
`std::__throw_bad_array_new_length()@GLIBCXX_3.4.29'

/home/sekigawa/anaconda3/lib/libQt5Core.so: undefined reference to \
`std::__exception_ptr::exception_ptr::_M_addref()@CXXABI_1.3.13'

collect2: error: ld returned 1 exit status
Makefile:279: recipe for target 'fontgen' failed
make[1]: *** [fontgen] Error 1


#================================================================================
# [4] Fix "fontgen" build errors
#================================================================================
(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-build-release/fontgen (1)$ pwd
/home/sekigawa/GitWork/klayout/ana3B-1-build-release/fontgen

(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-build-release/fontgen (2)$ ll
total 76
drwxrwxr-x  2 sekigawa sekigawa  4096 Jan 22 08:18 ./
drwxrwxr-x 30 sekigawa sekigawa  4096 Jan 22 08:19 ../
-rw-rw-r--  1 sekigawa sekigawa 56215 Jan 22 08:17 Makefile
-rw-rw-r--  1 sekigawa sekigawa 11400 Jan 22 08:18 fontgen.o

(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-build-release/fontgen (3)$ make
g++ -Wl,-O1 -Wl,-rpath,/home/sekigawa/anaconda3/lib -o ./fontgen fontgen.o   /home/sekigawa/anaconda3/lib/libQt5Widgets.so /home/sekigawa/anaconda3/lib/libQt5Gui.so /home/sekigawa/anaconda3/lib/libQt5Core.so -L/opt/conda/conda-bld/qt-main_1660123285207/_build_env/bin/../x86_64-conda-linux-gnu/sysroot/usr/lib64 -lGL -lpthread
/home/sekigawa/anaconda3/lib/libQt5Widgets.so: undefined reference to `std::pmr::monotonic_buffer_resource::~monotonic_buffer_resource()@GLIBCXX_3.4.28'
/home/sekigawa/anaconda3/lib/libQt5Core.so: undefined reference to `std::__exception_ptr::exception_ptr::_M_release()@CXXABI_1.3.13'
/home/sekigawa/anaconda3/lib/libQt5Widgets.so: undefined reference to `vtable for std::pmr::monotonic_buffer_resource@GLIBCXX_3.4.28'
/home/sekigawa/anaconda3/lib/libQt5Widgets.so: undefined reference to `std::pmr::get_default_resource()@GLIBCXX_3.4.26'
/home/sekigawa/anaconda3/lib/libQt5Widgets.so: undefined reference to `std::__throw_bad_array_new_length()@GLIBCXX_3.4.29'
/home/sekigawa/anaconda3/lib/libQt5Core.so: undefined reference to `std::__exception_ptr::exception_ptr::_M_addref()@CXXABI_1.3.13'
collect2: error: ld returned 1 exit status
Makefile:279: recipe for target 'fontgen' failed
make: *** [fontgen] Error 1

#--------------------------------------------------------------------------------
# [4-1] Find the root causes
#
# << Hypotheses >>
#    (1) g++  == /usr/bin/g++   g++ (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0 attempts
#        to link libstdc++.so under /usr/lib/x86_64-linux-gnu/
#    (2) But the library is old and does not contain those symbols
#--------------------------------------------------------------------------------
(base) sekigawa@LM19:~ (1)$ cd /usr/lib/x86_64-linux-gnu/

(base) sekigawa@LM19:/usr/lib/x86_64-linux-gnu (2)$ ll | grep stdc++
lrwxrwxrwx   1 root root       19 Mar 10  2020 libstdc++.so.6 -> libstdc++.so.6.0.25
-rw-r--r--   1 root root  1594864 Mar 10  2020 libstdc++.so.6.0.25  <=== older

(base) sekigawa@LM19:/usr/lib/x86_64-linux-gnu (3)$ strings libstdc++.so.6.0.25 | grep GLIBCXX
GLIBCXX_3.4
GLIBCXX_3.4.1
GLIBCXX_3.4.2
GLIBCXX_3.4.3
GLIBCXX_3.4.4
GLIBCXX_3.4.5
GLIBCXX_3.4.6
GLIBCXX_3.4.7
GLIBCXX_3.4.8
GLIBCXX_3.4.9
GLIBCXX_3.4.10
GLIBCXX_3.4.11
GLIBCXX_3.4.12
GLIBCXX_3.4.13
GLIBCXX_3.4.14
GLIBCXX_3.4.15
GLIBCXX_3.4.16
GLIBCXX_3.4.17
GLIBCXX_3.4.18
GLIBCXX_3.4.19
GLIBCXX_3.4.20
GLIBCXX_3.4.21
GLIBCXX_3.4.22
GLIBCXX_3.4.23
GLIBCXX_3.4.24
GLIBCXX_3.4.25
GLIBCXX_DEBUG_MESSAGE_LENGTH
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(base) sekigawa@LM19:~/anaconda3/lib (4)$ pwd
/home/sekigawa/anaconda3/lib

(base) sekigawa@LM19:~/anaconda3/lib (5)$ ll | grep stdc++
lrwxrwxrwx   1 sekigawa sekigawa        19 Jan 19 18:27 libstdc++.so -> libstdc++.so.6.0.29*
lrwxrwxrwx   1 sekigawa sekigawa        19 Jan 19 18:27 libstdc++.so.6 -> libstdc++.so.6.0.29*
-rwxrwxr-x   2 sekigawa sekigawa  17981480 Jun  1  2022 libstdc++.so.6.0.29*  <=== newer

(base) sekigawa@LM19:~/anaconda3/lib (6)$ strings libstdc++.so.6.0.29 | grep GLIBCXX_3.4.28
GLIBCXX_3.4.28  <=== there is!
GLIBCXX_3.4.28  <=== there is!


#--------------------------------------------------------------------------------
# [4-2] Edit "Makefile" so that /usr/bin/g++ can find "libstdc++.so.6.0.29"
#--------------------------------------------------------------------------------
(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-build-release/fontgen (4)$ diff Makefile*
43c43
< LIBS          = $(SUBLIBS) /home/sekigawa/anaconda3/lib/libQt5Widgets.so \
/home/sekigawa/anaconda3/lib/libQt5Gui.so /home/sekigawa/anaconda3/lib/libQt5Core.so \
-L/opt/conda/conda-bld/qt-main_1660123285207/_build_env/bin/../x86_64-conda-linux-gnu/sysroot/usr/lib64
-L/home/sekigawa/anaconda3/lib -lGL -lpthread
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
       add this
---
> LIBS          = $(SUBLIBS) /home/sekigawa/anaconda3/lib/libQt5Widgets.so
/home/sekigawa/anaconda3/lib/libQt5Gui.so /home/sekigawa/anaconda3/lib/libQt5Core.so \
-L/opt/conda/conda-bld/qt-main_1660123285207/_build_env/bin/../x86_64-conda-linux-gnu/sysroot/usr/lib64 \
-lGL -lpthread

#--------------------------------------------------------------------------------
# [4-3] make "fontgen"
#--------------------------------------------------------------------------------
(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-build-release/fontgen (5)$ make
g++ -Wl,-O1 -Wl,-rpath,/home/sekigawa/anaconda3/lib -o ./fontgen fontgen.o   \
/home/sekigawa/anaconda3/lib/libQt5Widgets.so /home/sekigawa/anaconda3/lib/libQt5Gui.so \
/home/sekigawa/anaconda3/lib/libQt5Core.so \
-L/opt/conda/conda-bld/qt-main_1660123285207/_build_env/bin/../x86_64-conda-linux-gnu/sysroot/usr/lib64 \
-L/home/sekigawa/anaconda3/lib -lGL -lpthread

/usr/bin/ld: warning: /home/sekigawa/anaconda3/lib/libstdc++.so: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010001
/usr/bin/ld: warning: /home/sekigawa/anaconda3/lib/libstdc++.so: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010002
/usr/bin/ld: warning: /home/sekigawa/anaconda3/lib/libgcc_s.so.1: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010001
/usr/bin/ld: warning: /home/sekigawa/anaconda3/lib/libgcc_s.so.1: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010002
/usr/bin/ld: warning: /home/sekigawa/anaconda3/lib/libgcc_s.so.1: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010001
/usr/bin/ld: warning: /home/sekigawa/anaconda3/lib/libgcc_s.so.1: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010002

(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-build-release/fontgen (5)$ ll
total 152
drwxrwxr-x  2 sekigawa sekigawa  4096 Jan 22 09:14 ./
drwxrwxr-x 30 sekigawa sekigawa  4096 Jan 22 08:19 ../
-rw-rw-r--  1 sekigawa sekigawa 56243 Jan 22 09:08 Makefile
-rw-rw-r--  1 sekigawa sekigawa 56215 Jan 22 08:17 Makefile.org
-rwxrwxr-x  1 sekigawa sekigawa 19176 Jan 22 09:14 fontgen*     <=== made!
-rw-rw-r--  1 sekigawa sekigawa 11400 Jan 22 08:18 fontgen.o


#================================================================================
# [5] Resume build
#================================================================================
(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-build-release (1)$ pwd
/home/sekigawa/GitWork/klayout/ana3B-1-build-release

(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-build-release (2)$ make 2>&1 | tee -a ../ana3B-1-build-release.log
:
:
:
ln -s libpymod_tests.so.0.28.3 libpymod_tests.so
ln -s libpymod_tests.so.0.28.3 libpymod_tests.so.0
ln -s libpymod_tests.so.0.28.3 libpymod_tests.so.0.28
cp -f libpymod_tests.so.0.28.3 /home/sekigawa/GitWork/klayout/ana3B-1-build-release/pymod/unit_tests/../../pymod_tests.ut
make[2]: Leaving directory '/home/sekigawa/GitWork/klayout/ana3B-1-build-release/pymod/unit_tests'
make[1]: Leaving directory '/home/sekigawa/GitWork/klayout/ana3B-1-build-release/pymod'
:
:
:
It looks ended without errors!

(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-build-release (3)$ make install
:
:
:
ONINCLUDE=/home/sekigawa/anaconda3/include/python3.9 PYTHONEXTSUFFIX=.cpython-39-x86_64-linux-gnu.so HAVE_PYTHON=1 HAVE_QTBINDINGS=1 HAVE_QT_UITOOLS=1 HAVE_QT_NETWORK=1 HAVE_QT_SQL=1 HAVE_QT_SVG=1 HAVE_QT_PRINTSUPPORT=1 HAVE_QT_MULTIMEDIA=1 HAVE_QT_DESIGNER=1 HAVE_QT_XML=1 HAVE_64BIT_COORD=0 HAVE_QT=1 HAVE_CURL=0 HAVE_EXPAT=0 HAVE_PNG=0 PREFIX=/home/sekigawa/GitWork/klayout/ana3B-1-bin-release RPATH=ana3B-1-bin-release KLAYOUT_VERSION=0.28.3 KLAYOUT_VERSION_DATE=2023-01-22 KLAYOUT_VERSION_REV=33af2b8fc RUBYINCLUDE=/home/sekigawa/anaconda3.B/include/ruby-3.1.0 RUBYINCLUDE2=/home/sekigawa/anaconda3.B/include/ruby-3.1.0/x86_64-linux ) && make -f Makefile install
make[2]: Entering directory '/home/sekigawa/GitWork/klayout/ana3B-1-build-release/pymod/unit_tests'
make[2]: Nothing to be done for 'install'.
make[2]: Leaving directory '/home/sekigawa/GitWork/klayout/ana3B-1-build-release/pymod/unit_tests'
make[1]: Leaving directory '/home/sekigawa/GitWork/klayout/ana3B-1-build-release/pymod'

(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-bin-release (4)$ pwd
/home/sekigawa/GitWork/klayout/ana3B-1-bin-release

(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-bin-release (5)$ ll *.sh
-rwxr-xr-x 1 sekigawa sekigawa 741 Jan 22 13:21 klayout.sh*

(base) sekigawa@LM19:~/GitWork/klayout/ana3B-1-bin-release (6)$ ./klayout.sh
+--------------------------+
|                          |
|      GUI shows up        |
|                          |
+--------------------------+

[EOF]
